---
import "../styles/global.css";
---

<!doctype html>
<html lang="en" class="h-lvh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>POLITEShop</title>
  </head>
  <body class="h-full dark" data-domain={Astro.locals.polite.domain}>
    <slot />

    <script>
      import type { WindowMessage } from "../../../shared";

      const politeDomain = (document.querySelector("body")! as HTMLElement).dataset.domain;

      window.top?.postMessage(
        {
          type: "LOCATION_CHANGED",
          payload: {
            path: location.pathname,
            title: document.title,
          },
        } as WindowMessage,
        `https://${politeDomain}.polite.edu.sg`
      );

      overridePOLITEShopLinks();

      // Call overridePOLITEShopLinks() when new links appear
      const observer = new MutationObserver((mutations) => {
        const mutationAffectedLink = mutations.some((mutation) => {
          // Check if a link was added
          for (const node of mutation.addedNodes) {
            if (node.nodeType !== Node.ELEMENT_NODE) continue;
            const element = node as HTMLElement;
            if (
              (element.tagName === "A" && element.hasAttribute("href") && !element.dataset.preserveUrl) ||
              element.querySelector("a[href]:not([data-preserve-url])")
            ) {
              return true;
            }
          }

          // Check if a href attribute was changed
          if (
            mutation.type === "attributes" &&
            mutation.target.nodeType === Node.ELEMENT_NODE &&
            mutation.attributeName === "href" &&
            !(mutation.target as HTMLElement).dataset.preserveUrl
          ) {
            return true;
          }

          return false;
        });

        if (mutationAffectedLink) overridePOLITEShopLinks();
      });

      // Start observing
      observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributeFilter: ["href"],
      });

      // Intercept link clicks for *.polite.edu.sg and redirect them to POLITEShop
      document.addEventListener("click", (e) => {
        if (!e.target) return;

        const a = (e.target as HTMLElement).closest("a");
        if (!a || a.hostname !== `${politeDomain}.polite.edu.sg`) return;

        e.preventDefault();
        window.location.pathname = a.pathname;
      });

      /** Change link URLs from POLITEShop's domain to `*.polite.edu.sg`. */
      function overridePOLITEShopLinks(container = document) {
        const links = container.querySelectorAll<HTMLAnchorElement>("a[href]:not([data-preserve-url])");
        links.forEach((link) => {
          if (link.host !== location.host) return;
          link.hostname = `${politeDomain}.polite.edu.sg`;
          link.port = "";
        });
      }
    </script>
  </body>
</html>
